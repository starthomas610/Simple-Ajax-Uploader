/**  Simple Ajax Uploader v1.9 Copyright 2012-2013 LPology, LLC  MIT license https://github.com/LPology/Simple-Ajax-Uploader */ 
(function(q,r,u){var d=q.ss||{},y=/^\s+/,z=/\s+$/,A=/[xy]/g,B=/.*(\/|\\)/,C=/.*[.]/,D=/[\t\r\n]/g,E=0<Object.prototype.toString.call(q.HTMLElement).indexOf("Constructor"),x=r.createElement("input"),w;x.type="file";w="multiple"in x&&"undefined"!==typeof File&&"undefined"!==typeof(new XMLHttpRequest).upload;d.obj2string=function(a,b){var c=[],e;for(e in a)if(a.hasOwnProperty(e)){var h=b?b+"["+e+"]":e,f=a[e];c.push("object"===typeof f?d.obj2string(f,h):encodeURIComponent(h)+"="+encodeURIComponent(f))}return c.join("&")};
d.extendObj=function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])};d.contains=function(a,b){for(var c=a.length;c--;)if(a[c]===b)return!0;return!1};d.removeItem=function(a,b){for(var c=a.length;c--;)if(a[c]===b){a.splice(c,1);break}};d.addEvent=function(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent("on"+b,c);return function(){d.removeEvent(a,b,c)}};d.removeEvent=function(a,b,c){a.removeEventListener?a.removeEventListener(b,c,!1):a.detachEvent("on"+b,c)};d.newXHR=function(){if("undefined"!==
typeof XMLHttpRequest)return new q.XMLHttpRequest;if(q.ActiveXObject)try{return new q.ActiveXObject("Microsoft.XMLHTTP")}catch(a){return!1}};d.parseJSON=function(a){if(!a)return!1;a=d.trim(a);if(q.JSON&&q.JSON.parse)try{return q.JSON.parse(a)}catch(b){return!1}return a&&/^[\],:{}\s]*$/.test(a.replace(/\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g,"@").replace(/"[^"\\\r\n]*"|true|false|null|-?(?:\d+\.|)\d+(?:[eE][+-]?\d+|)/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))?(new Function("return "+a))():!1};d.getBox=
function(a){var b,c=0;b=0;if(a.getBoundingClientRect)a=a.getBoundingClientRect(),b=r.documentElement,c=a.top+(q.pageYOffset||b.scrollTop)-(b.clientTop||0),b=a.left+(q.pageXOffset||b.scrollLeft)-(b.clientLeft||0);else{do b+=a.offsetLeft,c+=a.offsetTop;while(a=a.offsetParent)}return{top:Math.round(c),left:Math.round(b)}};d.addStyles=function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a.style[c]=b[c])};d.copyLayout=function(a,b){var c=d.getBox(a);d.addStyles(b,{position:"absolute",left:c.left+"px",top:c.top+
"px",width:a.offsetWidth+"px",height:a.offsetHeight+"px"})};d.toElement=function(){var a=r.createElement("div");return function(b){a.innerHTML=b;b=a.firstChild;a.removeChild(b);return b}}();d.getUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(A,function(a){var b=16*Math.random()|0;return("x"==a?b:b&3|8).toString(16)})};d.trim=function(a){return a.toString().replace(y,"").replace(z,"")};d.getFilename=function(a){return a.replace(B,"")};d.getExt=function(a){return-1!==a.indexOf(".")?
a.replace(C,""):""};d.hasClass=function(a,b){return 0<=(" "+a.className+" ").replace(D," ").indexOf(" "+b+" ")};d.addClass=function(a,b){if(!b||""===b)return!1;d.hasClass(a,b)||(a.className+=" "+b)};d.removeClass=function(){var a={};return function(b,c){a[c]||(a[c]=RegExp("(?:^|\\s)"+c+"(?!\\S)"));b.className=b.className.replace(a[c],"")}}();d.purge=function(a){var b=a.attributes,c,e;if(b)for(c=b.length-1;0<=c;c-=1)e=b[c].name,"function"===typeof a[e]&&(a[e]=null);if(b=a.childNodes)for(b=b.length,
c=0;c<b;c+=1)d.purge(a.childNodes[c])};d.remove=function(a){a.parentNode&&(d.purge(a),a.parentNode.removeChild(a))};d.verifyElem=function(a){"undefined"!==typeof jQuery&&a instanceof jQuery?a=a[0]:"string"===typeof a&&("#"==a.charAt(0)&&(a=a.substr(1)),a=r.getElementById(a));if(!a||1!==a.nodeType)return!1;"A"==a.nodeName.toUpperCase()&&(a.style.cursor="pointer",d.addEvent(a,"click",function(a){a&&a.preventDefault?a.preventDefault():q.event&&(q.event.returnValue=!1)}));return a};d.SimpleUpload=function(a){var b,
c;this._opts={button:"",url:"",cors:!1,progressUrl:!1,nginxProgressUrl:!1,multiple:!1,maxUploads:3,queue:!0,checkProgressInterval:50,keyParamName:"APC_UPLOAD_PROGRESS",nginxProgressHeader:"X-Progress-ID",corsInputName:"XHR_CORS_TARGETORIGIN",allowedExtensions:[],accept:"",maxSize:!1,name:"",data:{},autoSubmit:!0,multipart:!1,method:"POST",responseType:"",debug:!1,hoverClass:"",focusClass:"",disabledClass:"",onAbort:function(a,b){},onChange:function(a,b,c){},onSubmit:function(a,b,c){},onProgress:function(a){},
onUpdateFileSize:function(a){},onComplete:function(a,b,c){},onExtError:function(a,b){},onSizeError:function(a,b){},onError:function(a,b,c,d,g){},startXHR:function(a,b,c){},endXHR:function(a,b,c){},startNonXHR:function(a,b){},endNonXHR:function(a,b){}};d.extendObj(this._opts,a);a=null;this._btns=[];if(this._opts.button instanceof Array)for(b=this._opts.button.length,a=0;a<b;a++)c=d.verifyElem(this._opts.button[a]),!1!==c?this._btns.push(this.rerouteClicks(c)):this.log("Button with array index "+a+
" is invalid");else c=d.verifyElem(this._opts.button),!1!==c&&this._btns.push(this.rerouteClicks(c));delete this._opts.button;if(1>this._btns.length||!1===this._btns[0])throw Error("Invalid button. Make sure the element you're passing exists.");!1===this._opts.multiple&&(this._opts.maxUploads=1);this._queue=[];this._active=0;this._disabled=!1;this._progKeys=[];this._maxFails=10;w||(this._sizeFlags={});this._createInput();this.enable()};d.SimpleUpload.prototype={destroy:function(){for(var a=this._btns.length;a--;)this._btns[a].off&&
this._btns[a].off(),d.removeClass(this._btns[a],this._opts.hoverClass),d.removeClass(this._btns[a],this._opts.focusClass),d.removeClass(this._btns[a],this._opts.disabledClass),this._btns[a].disabled=!1;d.remove(this._input.parentNode);for(var b in this)this.hasOwnProperty(b)&&delete this.prop},log:function(a){this._opts.debug&&q.console&&console.log("[uploader] "+a)},setData:function(a){this._opts.data=a},setProgressBar:function(a){this._progBar=d.verifyElem(a)},setPctBox:function(a){this._pctBox=
d.verifyElem(a)},setFileSizeBox:function(a){this._sizeBox=d.verifyElem(a)},setProgressContainer:function(a){this._progBox=d.verifyElem(a)},setAbortBtn:function(a,b){this._abortBtn=d.verifyElem(a);this._removeAbort=!1;b&&(this._removeAbort=!0)},getQueueSize:function(){return this._queue.length},_cycleQueue:function(){0<this._queue.length&&this._opts.autoSubmit&&this.submit()},removeCurrent:function(){for(var a=this._queue.length;a--;)if(this._queue[a].file===this._file){this._queue.splice(a,1);break}delete this._file;
this._cycleQueue()},disable:function(){var a=this._btns.length,b;for(this._disabled=!0;a--;)if(b=this._btns[a].nodeName.toUpperCase(),d.addClass(this._btns[a],this._opts.disabledClass),"INPUT"==b||"BUTTON"==b)this._btns[a].disabled=!0;this._input&&this._input.parentNode&&(this._input.parentNode.style.visibility="hidden")},enable:function(){var a=this._btns.length;for(this._disabled=!1;a--;)d.removeClass(this._btns[a],this._opts.disabledClass),this._btns[a].disabled=!1},_getHost:function(a){var b=
r.createElement("a");b.href=a;return b.hostname?b.hostname.toLowerCase():a},_createInput:function(){var a=this,b=r.createElement("div");this._input=r.createElement("input");this._input.type="file";this._input.name=this._opts.name;w&&!E&&(this._input.multiple=!0);"accept"in this._input&&""!==this._opts.accept&&(this._input.accept=this._opts.accept);d.addStyles(b,{display:"block",position:"absolute",overflow:"hidden",margin:0,padding:0,opacity:0,direction:"ltr",zIndex:2147483583});d.addStyles(this._input,
{position:"absolute",right:0,margin:0,padding:0,fontSize:"480px",fontFamily:"sans-serif",cursor:"pointer"});"0"!==b.style.opacity&&(b.style.filter="alpha(opacity=0)");d.addEvent(this._input,"change",function(){var b=a._overBtn,e,h;if(a._input&&""!==a._input.value){if(w){e=d.getFilename(a._input.files[0].name);h=d.getExt(e);if(!1===a._opts.onChange.call(a,e,h,b))return;e=a._input.files.length;a._opts.multiple||(e=1);for(h=0;h<e;h++)a._queue.push({file:a._input.files[h],btn:b})}else{e=d.getFilename(a._input.value);
h=d.getExt(e);if(!1===a._opts.onChange.call(a,e,h,b))return;a._queue.push({file:a._input,btn:b})}d.removeClass(a._overBtn,a._opts.hoverClass);d.removeClass(a._overBtn,a._opts.focusClass);d.remove(a._input.parentNode);delete a._input;a._createInput();a._opts.autoSubmit&&a.submit()}});d.addEvent(this._input,"mouseover",function(){d.addClass(a._overBtn,a._opts.hoverClass)});d.addEvent(this._input,"mouseout",function(){d.removeClass(a._overBtn,a._opts.hoverClass);d.removeClass(a._overBtn,a._opts.focusClass);
a._input.parentNode.style.visibility="hidden"});d.addEvent(this._input,"focus",function(){d.addClass(a._overBtn,a._opts.focusClass)});d.addEvent(this._input,"blur",function(){d.removeClass(a._overBtn,a._opts.focusClass)});r.body.appendChild(b);b.appendChild(this._input)},rerouteClicks:function(a){var b=this;a.off=d.addEvent(a,"mouseover",function(){b._disabled||(b._input||b._createInput(),b._overBtn=a,d.copyLayout(a,b._input.parentNode),b._input.parentNode.style.visibility="visible")});return a},
_getFrame:function(){var a=d.getUID(),b=d.toElement('<iframe src="javascript:false;" name="'+a+'" />');r.body.appendChild(b);b.style.display="none";b.id=a;return b},_getForm:function(a,b){var c=d.toElement('<form method="post" enctype="multipart/form-data"></form>'),e=this._opts.url;r.body.appendChild(c);c.style.display="none";this._opts.nginxProgressUrl&&(e=e+(-1<e.indexOf("?")?"&":"?")+encodeURIComponent(this._opts.nginxProgressHeader)+"="+encodeURIComponent(b));c.action=e;c.target=a.name;return c},
_getHidden:function(a,b){var c=r.createElement("input");c.type="hidden";c.name=a;c.value=b;return c},_last:function(a,b,c,e,h){a&&(a.innerHTML="");b&&d.remove(b);c&&(c.innerHTML="");e&&h&&d.remove(e);this._active--;this._disabled&&this.enable();this._cycleQueue()},_errorFinish:function(a,b,c,d,h,f,k,g,l,m){this.log("Upload failed: "+a+" "+b);this._opts.onError.call(this,d,c,a,b,m);this._last(h,f,k,g,l)},_finish:function(a,b,c,e,h,f,k,g,l,m){this.log("Server response: "+c);if("json"==this._opts.responseType.toLowerCase()&&
(c=d.parseJSON(c),!1===c)){this._errorFinish(a,b,"parseerror",e,h,f,g,l,m);return}this._opts.onComplete.call(this,e,c,m);this._last(h,f,k,g,l)},_uploadXhr:function(a,b,c,e,h,f,k,g,l){var m=this,p=this._opts,s=d.newXHR(),n={},q,v;n[p.name]=a;d.extendObj(n,p.data);n=p.url+(-1<p.url.indexOf("?")?"&":"?")+d.obj2string(n);c&&(c.innerHTML=b+"K");f&&(f.innerHTML="0%");e&&(e.style.width="0%");p.onProgress.call(this,0);q=function(d,e){var n,t;try{if(q&&(e||4===s.readyState))if(q=u,s.onreadystatechange=function(){},
e)4!==s.readyState&&s.abort(),m._last(c,h,f,k,g),p.onAbort.call(m,a,l);else{n=s.status;try{t=s.statusText}catch(v){t=""}200<=n&&300>n?(p.endXHR.call(m,a,b,l),m._finish(n,t,s.responseText,a,c,h,f,k,g,l)):m._errorFinish(n,t,"error",a,c,h,f,k,g,l)}}catch(r){e||m._errorFinish(-1,r.message,"error",a,c,h,f,k,g,l)}};v=function(){d.removeEvent(k,"click",v);q&&q(u,!0)};k&&d.addEvent(k,"click",v);s.onreadystatechange=q;s.open(p.method.toUpperCase(),n,!0);d.addEvent(s.upload,"progress",function(a){a.lengthComputable&&
(a=Math.round(a.loaded/a.total*100),p.onProgress.call(m,a),f&&(f.innerHTML=a+"%"),e&&(e.style.width=a+"%"))});s.setRequestHeader("X-Requested-With","XMLHttpRequest");s.setRequestHeader("X-File-Name",encodeURIComponent(a));"json"==p.responseType.toLowerCase()&&s.setRequestHeader("Accept","application/json, text/javascript, */*; q=0.01");if(!0===p.multipart){var n=new FormData,t;for(t in p.data)p.data.hasOwnProperty(t)&&n.append(t,p.data[t]);n.append(p.name,this._file);this.log("Commencing upload using multipart form");
s.send(n)}else s.setRequestHeader("Content-Type","application/octet-stream"),this.log("Commencing upload using binary stream"),s.send(this._file);this.removeCurrent()},_uploadIframe:function(a,b,c,e,h,f){var k=this,g=this._opts,l=d.getUID(),m=this._getFrame(),p=this._getForm(m,l),s=!1,n,r;g.progressUrl&&p.appendChild(this._getHidden(g.keyParamName,l));for(var v in g.data)g.data.hasOwnProperty(v)&&p.appendChild(this._getHidden(v,g.data[v]));g.cors&&p.appendChild(this._getHidden(g.corsInputName,q.location.href));
p.appendChild(this._file);g.onProgress.call(this,0);h&&(h.innerHTML="0%");c&&(c.style.width="0%");g.cors&&(n=d.addEvent(q,"message",function(c){k._getHost(c.origin)!=k._getHost(g.url)?k.log("Non-matching origin: "+c.origin):(s=!0,n(),g.endNonXHR.call(k,a,f),k._finish("","",c.data,a,b,e,h,u,u,f))}));r=d.addEvent(m,"load",function(){if(m.parentNode)if(r(),d.removeItem(k._progKeys,l),k._sizeFlags[l]&&delete k._sizeFlags.key,g.cors)q.setTimeout(function(){d.remove(m);s||k._errorFinish("","","error",a,
b,e,h,u,u,f);g=l=m=b=e=h=f=null},600);else{try{var c=(m.contentDocument?m.contentDocument:m.contentWindow.document).body.innerHTML;g.endNonXHR.call(k,a,f);k._finish("","",c,a,b,e,h,u,u,f)}catch(n){k._errorFinish("",n.message,"error",a,b,e,h,u,u,f)}d.remove(m);g=l=m=b=e=h=f=null}});k.log("Commencing upload using iframe");p.submit();d.remove(p);p=null;if(g.progressUrl||g.nginxProgressUrl)this._progKeys.push(l),q.setTimeout(function(){k._getProg(l,c,b,h,1);c=b=h=null},g.checkProgressInterval);this.removeCurrent()},
_getProg:function(a,b,c,e,h){var f=this,k=this._opts,g=(new Date).getTime(),l,m,p;if(a){k.nginxProgressUrl?m=k.nginxProgressUrl+"?"+encodeURIComponent(k.nginxProgressHeader)+"="+encodeURIComponent(a)+"&_="+g:k.progressUrl&&(m=k.progressUrl+"?progresskey="+encodeURIComponent(a)+"&_="+g);p=function(){var g,n,m,r,t;try{if(p&&(k.cors||4===l.readyState)){p=u;l.onreadystatechange=function(){};try{t=l.statusText,r=l.status}catch(w){r=t=""}if(k.cors||200<=r&&300>r){g=d.parseJSON(l.responseText);h++;if(!1===
g){f.log("Error parsing progress response (expecting JSON)");return}if(k.nginxProgressUrl)if("uploading"==g.state)n=g.size,0<n&&(m=Math.round(g.received/n*100),n=Math.round(n/1024));else if("done"==g.state)m=100;else{if("error"==g.state){f.log("Error requesting upload progress: "+g.status);return}}else k.progressUrl&&!0===g.success&&(n=g.size,m=g.pct);m&&(e&&(e.innerHTML=m+"%"),b&&(b.style.width=m+"%"),k.onProgress.call(f,m));n&&!f._sizeFlags[a]&&(f._sizeFlags[a]=1,c&&(c.innerHTML=n+"K"),k.onUpdateFileSize.call(f,
n));if(!m&&!n&&h>=f._maxFails){f.log("Failed progress request limit reached");return}100>m&&d.contains(f._progKeys,a)&&q.setTimeout(function(){f._getProg(a,b,c,e,h);a=b=c=e=h=null},k.checkProgressInterval)}else d.removeItem(f._progKeys,a),f.log("Error requesting upload progress: "+r+" "+t);l=n=m=r=t=g=null}}catch(x){f.log("Error requesting upload progress: "+x.message)}};if(k.cors)if("undefined"!==typeof XDomainRequest)l=new q.XDomainRequest,l.open("GET",m,!0),l.onprogress=l.ontimeout=function(){},
l.onload=p,l.onerror=function(){d.removeItem(f._progKeys,a);a=null;f.log("Error requesting upload progress")};else return;else l=d.newXHR(),l.onreadystatechange=p,l.open("GET",m,!0),k.nginxProgressUrl&&l.setRequestHeader(k.nginxProgressHeader,a),l.setRequestHeader("X-Requested-With","XMLHttpRequest"),l.setRequestHeader("Accept","application/json, text/javascript, */*; q=0.01");l.send()}},_checkFile:function(a,b,c){var d=this._opts.allowedExtensions,h=d.length,f=!1;if(0<h){for(b=b.toLowerCase();h--;)if(d[h].toLowerCase()==
b){f=!0;break}if(!f)return this.removeCurrent(),this.log("File extension not permitted"),this._opts.onExtError.call(this,a,b),!1}return c&&!1!==this._opts.maxSize&&c>this._opts.maxSize?(this.removeCurrent(),this.log(a+" exceeds "+this._opts.maxSize+"K limit"),this._opts.onSizeError.call(this,a,c),!1):!0},submit:function(){var a,b,c;if(!(this._disabled||this._active>=this._opts.maxUploads||1>this._queue.length)&&(this._file=this._queue[0].file,w?(a=d.getFilename(this._file.name),c=Math.round(this._file.size/
1024)):a=d.getFilename(this._file.value),b=d.getExt(a),this._checkFile(a,b,c)&&!1!==this._opts.onSubmit.call(this,a,b,this._queue[0].btn))){this._active++;(!1===this._opts.multiple||!1===this._opts.queue&&this._active>=this._opts.maxUploads)&&this.disable();if(w){if(!1===this._opts.startXHR.call(this,a,c,this._queue[0].btn)){this._disabled&&this.enable();this._active--;return}this._uploadXhr(a,c,this._sizeBox,this._progBar,this._progBox,this._pctBox,this._abortBtn,this._removeAbort,this._queue[0].btn)}else{if(!1===
this._opts.startNonXHR.call(this,a,this._queue[0].btn)){this._disabled&&this.enable();this._active--;return}this._uploadIframe(a,this._sizeBox,this._progBar,this._progBox,this._pctBox,this._queue[0].btn)}this._sizeBox=this._progBar=this._progBox=this._pctBox=this._abortBtn=this._removeAbort=null}}};q.ss=d})(window,document);