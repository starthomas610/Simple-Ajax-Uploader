/**  Simple Ajax Uploader v1.8 Copyright 2012-2013 LPology, LLC  MIT license https://github.com/LPology/Simple-Ajax-Uploader */ 
(function(p,n,v){var c=p.ss||{},x=/^\s+/,w=/\s+$/,y=/[xy]/g,z=/.*(\/|\\)/,A=/.*[.]/,B=/[\t\r\n]/g;c.obj2string=function(a,b){var d=[],f;for(f in a)if(a.hasOwnProperty(f)){var m=b?b+"["+f+"]":f,e=a[f];d.push("object"===typeof e?c.obj2string(e,m):encodeURIComponent(m)+"="+encodeURIComponent(e))}return d.join("&")};c.extendObj=function(a,b){for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d])};c.contains=function(a,b){for(var d=a.length;d--;)if(a[d]===b)return!0;return!1};c.removeItem=function(a,b){for(var d=
a.length;d--;)if(a[d]===b){a.splice(d,1);break}};c.addEvent=function(a,b,d){a.addEventListener?a.addEventListener(b,d,!1):a.attachEvent("on"+b,d)};c.removeEvent=function(a,b,d){a.removeEventListener?a.removeEventListener(b,d,!1):a.detachEvent("on"+b,d)};c.newXHR=function(){if("undefined"!==typeof XMLHttpRequest)return new p.XMLHttpRequest;if(p.ActiveXObject)try{return new p.ActiveXObject("Microsoft.XMLHTTP")}catch(a){return!1}};c.parseJSON=function(a){if(!a)return!1;a=c.trim(a);if(p.JSON&&p.JSON.parse)try{return p.JSON.parse(a)}catch(b){return!1}return a&&
/^[\],:{}\s]*$/.test(a.replace(/\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g,"@").replace(/"[^"\\\r\n]*"|true|false|null|-?(?:\d+\.|)\d+(?:[eE][+-]?\d+|)/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))?(new Function("return "+a))():!1};c.getBox=function(a){var b,d=0;b=0;if(a.getBoundingClientRect)a=a.getBoundingClientRect(),b=n.documentElement,d=a.top+(p.pageYOffset||b.scrollTop)-(b.clientTop||0),b=a.left+(p.pageXOffset||b.scrollLeft)-(b.clientLeft||0);else{do b+=a.offsetLeft,d+=a.offsetTop;while(a=a.offsetParent)
}return{top:Math.round(d),left:Math.round(b)}};c.addStyles=function(a,b){for(var d in b)b.hasOwnProperty(d)&&(a.style[d]=b[d])};c.copyLayout=function(a,b){var d=c.getBox(a);c.addStyles(b,{position:"absolute",left:d.left+"px",top:d.top+"px",width:a.offsetWidth+"px",height:a.offsetHeight+"px"})};c.toElement=function(){var a=n.createElement("div");return function(b){a.innerHTML=b;b=a.firstChild;a.removeChild(b);return b}}();c.getUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(y,function(a){var b=
16*Math.random()|0;return("x"==a?b:b&3|8).toString(16)})};c.trim=function(a){return a.toString().replace(x,"").replace(w,"")};c.getFilename=function(a){return a.replace(z,"")};c.getExt=function(a){return-1!==a.indexOf(".")?a.replace(A,""):""};c.hasClass=function(a,b){return 0<=(" "+a.className+" ").replace(B," ").indexOf(" "+b+" ")};c.addClass=function(a,b){if(!b||""===b)return!1;c.hasClass(a,b)||(a.className+=" "+b)};c.removeClass=function(){var a={};return function(b,d){a[d]||(a[d]=RegExp("(?:^|\\s)"+
d+"(?!\\S)"));b.className=b.className.replace(a[d],"")}}();c.purge=function(a){var b=a.attributes,d,f;if(b)for(d=b.length-1;0<=d;d-=1)f=b[d].name,"function"===typeof a[f]&&(a[f]=null);if(b=a.childNodes)for(b=b.length,d=0;d<b;d+=1)c.purge(a.childNodes[d])};c.remove=function(a){c.purge(a);a.parentNode&&a.parentNode.removeChild(a)};c.verifyElem=function(a){"undefined"!==typeof jQuery&&a instanceof jQuery?a=a[0]:"string"===typeof a&&("#"==a.charAt(0)&&(a=a.substr(1)),a=n.getElementById(a));if(!a||1!==
a.nodeType)return!1;"A"==a.nodeName.toUpperCase()&&(a.style.cursor="pointer",c.addEvent(a,"click",function(a){a&&a.preventDefault?a.preventDefault():p.event&&(p.event.returnValue=!1)}));return a};c.SimpleUpload=function(a){var b,d;this._opts={button:"",url:"",progressUrl:!1,nginxProgressUrl:!1,multiple:!1,maxUploads:3,queue:!0,checkProgressInterval:50,keyParamName:"APC_UPLOAD_PROGRESS",nginxProgressHeader:"X-Progress-ID",allowedExtensions:[],accept:"",maxSize:!1,name:"",data:{},autoSubmit:!0,multipart:!1,
method:"POST",responseType:"",debug:!1,hoverClass:"",focusClass:"",disabledClass:"",onCancel:function(a){},onChange:function(a,b){},onSubmit:function(a,b){},onProgress:function(a){},onUpdateFileSize:function(a){},onComplete:function(a,b){},onExtError:function(a,b){},onSizeError:function(a,b){},onError:function(a,b,d,c){},startXHR:function(a,b){},endXHR:function(a,b){},startNonXHR:function(a){},endNonXHR:function(a){}};c.extendObj(this._opts,a);a=null;this._btns=[];if(this._opts.button instanceof Array)for(b=
this._opts.button.length,a=0;a<b;a++)d=c.verifyElem(this._opts.button[a]),!1!==d?this._btns.push(d):this.log("Button with array index "+a+" is invalid");else this._btns[0]=c.verifyElem(this._opts.button);delete this._opts.button;this._numBtns=this._btns.length;if(1>this._numBtns||!1===this._btns[0])throw Error("Invalid button. Make sure the element you're passing exists.");!1===this._opts.multiple&&(this._opts.maxUploads=1);this._queue=[];this._active=0;this._disabled=!1;this._progKeys=[];this._maxFails=
10;if(this._isXhrOk())this._XhrOk=!0;else if(this._XhrOk=!1,this._opts.progressUrl||this._opts.nginxProgressUrl)this._progKey=c.getUID();this._isSafari=0<Object.prototype.toString.call(p.HTMLElement).indexOf("Constructor");this._createInput();this.enable();for(a=0;a<this._numBtns;a++)this.rerouteClicks(this._btns[a])};c.SimpleUpload.prototype={log:function(a){this._opts.debug&&p.console&&console.log("[uploader] "+a)},setData:function(a){this._opts.data=a},setProgressBar:function(a){this._progBar=
c.verifyElem(a)},setPctBox:function(a){this._pctBox=c.verifyElem(a)},setFileSizeBox:function(a){this._sizeBox=c.verifyElem(a)},setProgressContainer:function(a){this._progBox=c.verifyElem(a)},setAbortBtn:function(a,b){this._abortBtn=c.verifyElem(a);this._removeAbort=!1;b&&(this._removeAbort=!0)},getQueueSize:function(){return this._queue.length},_cycleQueue:function(){0<this._queue.length&&this._opts.autoSubmit&&this.submit()},removeCurrent:function(){c.removeItem(this._queue,this._file);delete this._file;
this._file=null;this._cycleQueue()},disable:function(){var a,b;for(a=0;a<this._numBtns;a++)if(b=this._btns[a].nodeName.toUpperCase(),c.addClass(this._btns[a],this._opts.disabledClass),this._disabled=!0,"INPUT"==b||"BUTTON"==b)this._btns[a].disabled=!0;this._input&&this._input.parentNode&&(this._input.parentNode.style.visibility="hidden")},enable:function(){var a;for(a=0;a<this._numBtns;a++)c.removeClass(this._btns[a],this._opts.disabledClass),this._btns[a].disabled=!1;this._disabled=!1},_isXhrOk:function(){var a=
n.createElement("input");a.type="file";return"multiple"in a&&"undefined"!=typeof File&&"undefined"!=typeof(new XMLHttpRequest).upload},_createInput:function(){var a=this,b=n.createElement("div");this._input=n.createElement("input");this._input.type="file";this._input.name=this._opts.name;this._XhrOk&&!this._isSafari&&(this._input.multiple=!0);"accept"in this._input&&""!==this._opts.accept&&(this._input.accept=this._opts.accept);c.addStyles(b,{display:"block",position:"absolute",overflow:"hidden",
margin:0,padding:0,opacity:0,direction:"ltr",zIndex:2147483583});c.addStyles(this._input,{position:"absolute",right:0,margin:0,padding:0,fontSize:"480px",fontFamily:"sans-serif",cursor:"pointer"});"0"!==b.style.opacity&&(b.style.filter="alpha( opacity=0 )");c.addEvent(this._input,"change",function(){var b,f;if(a._input&&""!==a._input.value){if(a._XhrOk){b=c.getFilename(a._input.files[0].name);f=c.getExt(b);if(!1===a._opts.onChange.call(a,b,f))return;b=a._input.files.length;a._opts.multiple||(b=1);
for(f=0;f<b;f++)a._queue.push(a._input.files[f])}else{b=c.getFilename(a._input.value);f=c.getExt(b);if(!1===a._opts.onChange.call(a,b,f))return;a._queue.push(a._input)}c.removeClass(a._overBtn,a._opts.hoverClass);c.removeClass(a._overBtn,a._opts.focusClass);c.remove(a._input.parentNode);delete a._input;a._input=null;a._createInput();a._opts.autoSubmit&&a.submit()}});c.addEvent(this._input,"mouseover",function(){c.addClass(a._overBtn,a._opts.hoverClass)});c.addEvent(this._input,"mouseout",function(){c.removeClass(a._overBtn,
a._opts.hoverClass);c.removeClass(a._overBtn,a._opts.focusClass);a._input.parentNode.style.visibility="hidden"});c.addEvent(this._input,"focus",function(){c.addClass(a._overBtn,a._opts.focusClass)});c.addEvent(this._input,"blur",function(){c.removeClass(a._overBtn,a._opts.focusClass)});n.body.appendChild(b);b.appendChild(this._input)},rerouteClicks:function(a){var b=this;a=c.verifyElem(a);if(!a)return!1;c.addEvent(a,"mouseover",function(){b._disabled||(b._input||b._createInput(),b._overBtn=a,c.copyLayout(a,
b._input.parentNode),b._input.parentNode.style.visibility="visible")})},_getFrame:function(){var a=c.getUID(),b=c.toElement('<iframe src="javascript:false;" name="'+a+'" />');n.body.appendChild(b);b.style.display="none";b.id=a;return b},_getForm:function(a){var b=c.toElement('<form method="post" enctype="multipart/form-data"></form>');n.body.appendChild(b);b.style.display="none";b.action=this._opts.url;b.target=a.name;return b},_getHidden:function(a,b){var c=n.createElement("input");c.type="hidden";
c.name=a;c.value=b;return c},_last:function(a,b,d,f,m){a&&(a.innerHTML="");b&&c.remove(b);d&&(d.innerHTML="");f&&m&&c.remove(f);this._active--;this._disabled&&this.enable();this._cycleQueue()},_errorFinish:function(a,b,c,f,m,e,k,h,g){this.log("Upload failed: "+a+" "+b);this._opts.onError.call(this,f,c,a,b);this._last(m,e,k,h,g)},_finish:function(a,b,d,f,m,e,k,h,g){var l=d;if("json"==this._opts.responseType.toLowerCase()&&(d=c.parseJSON(d),!1===d)){this._errorFinish(a,b,"parseerror",f,m,e,h,g);return}this.log("Server response: "+
l);this._opts.onComplete.call(this,f,d);this._last(m,e,k,h,g)},_uploadXhr:function(a,b,d,f,m,e){var k=this,h=this._opts,g=c.newXHR(),l={},q,r,t,p;if(!1===h.startXHR.call(this,a,b))this._disabled&&this.enable(),this._active--;else{r=this._abortBtn;t=this._removeAbort;this._abortBtn=this._removeAbort=null;l[h.name]=a;c.extendObj(l,h.data);l=h.url+"?"+c.obj2string(l);d&&(d.innerHTML=b+"K");e&&(e.innerHTML="0%");f&&(f.style.width="0%");h.onProgress.call(this,0);q=function(c,f){var l,p;try{if(q&&(f||4===
g.readyState))if(g.onreadystatechange=function(){},q=v,f)4!==g.readyState&&g.abort(),k._last(d,m,e,r,t),h.onAbort.call(k,a);else{l=g.status;try{p=g.statusText}catch(n){p=""}200<=l&&300>l?(h.endXHR.call(k,a,b),k._finish(l,p,g.responseText,a,d,m,e,r,t)):k._errorFinish(l,p,"error",a,d,m,e,r,t)}}catch(s){f||k._errorFinish(-1,s.message,"error",a,d,m,e,r,t)}};p=function(){c.removeEvent(r,"click",p);q&&q(v,!0)};r&&c.addEvent(r,"click",p);g.onreadystatechange=q;g.open(h.method.toUpperCase(),l,!0);c.addEvent(g.upload,
"progress",function(a){a.lengthComputable&&(a=Math.round(100*(a.loaded/a.total)),h.onProgress.call(k,a),e&&(e.innerHTML=a+"%"),f&&(f.style.width=a+"%"))});g.setRequestHeader("X-Requested-With","XMLHttpRequest");g.setRequestHeader("X-File-Name",encodeURIComponent(a));"json"==h.responseType.toLowerCase()&&g.setRequestHeader("Accept","application/json, text/javascript, */*; q=0.01");if(!0===h.multipart){var l=new FormData,n;for(n in h.data)h.data.hasOwnProperty(n)&&l.append(n,h.data[n]);l.append(h.name,
this._file);this.log("Commencing upload using multipart form");g.send(l)}else g.setRequestHeader("Content-Type","application/octet-stream"),this.log("Commencing upload using binary stream"),g.send(this._file);this.removeCurrent()}},_uploadIframe:function(a,b,d,f,m){var e=this,k=this._opts,h=this._progKey,g=this._getFrame(),l=this._getForm(g),q;if(!1===k.startNonXHR.call(this,a))this._disabled&&this.enable(),this._active--;else{this._opts.nginxProgressUrl&&(l.action=this._opts.url+"?"+this._opts.nginxProgressHeader+
"="+h);!1!==k.progressUrl&&(q=this._getHidden(k.keyParamName,h),l.appendChild(q),q=null);for(var r in k.data)k.data.hasOwnProperty(r)&&(q=this._getHidden(r,k.data[r]),l.appendChild(q));l.appendChild(this._file);k.onProgress.call(this,0);m&&(m.innerHTML="0%");d&&(d.style.width="0%");c.addEvent(g,"load",function(){try{var d=(g.contentDocument?g.contentDocument:g.contentWindow.document).body.innerHTML;c.removeEvent(g,"load",arguments.callee);c.remove(g);c.removeItem(e._progKeys,h);k.endNonXHR.call(e,
a);e._finish("","",d,a,b,f,m)}catch(l){e._errorFinish("",l.message,"error",a,b,f,m)}k=h=g=b=f=m=null});e.log("Commencing upload using iframe");l.submit();c.remove(l);l=q=null;if(this._opts.progressUrl||this._opts.nginxProgressUrl)this._progKeys.push(h),p.setTimeout(function(){e._getProg(h,d,b,m,1);h=d=b=m=null},e._opts.checkProgressInterval),this._progKey=c.getUID();this.removeCurrent()}},_getProg:function(a,b,d,f,m){var e=this,k=c.newXHR(),h=(new Date).getTime(),g,l;a&&(this._opts.nginxProgressUrl?
g=e._opts.nginxProgressUrl+"?_="+h:this._opts.progressUrl&&(g=e._opts.progressUrl+"?progresskey="+encodeURIComponent(a)+"&_="+h),l=function(){var g,h,n,s,u;try{if(l&&4===k.readyState){k.onreadystatechange=function(){};l=v;s=k.status;try{u=k.statusText}catch(x){u=""}if(200<=s&&300>s){g=c.parseJSON(k.responseText);m++;if(!1===g){e.log("Error parsing progress response (expecting JSON)");return}if(e._opts.nginxProgressUrl)if("uploading"==g.state)h=g.size,0<h&&(n=Math.round(100*(g.received/h)),h=Math.round(h/
1024));else if("done"==g.state)n=100;else{if("error"==g.state){e.log("Error requesting upload progress: "+g.status);return}}else e._opts.progressUrl&&!0===g.success&&(h=g.size,n=g.pct);n&&(f&&(f.innerHTML=n+"%"),b&&(b.style.width=n+"%"),e._opts.onProgress.call(e,n));h&&(d&&(d.innerHTML=h+"K"),e._opts.onUpdateFileSize.call(e,h));if(!n&&!h&&m>=e._maxFails){e.log("Failed progress request limit reached");return}100>n&&c.contains(e._progKeys,a)&&p.setTimeout(function(){e._getProg(a,b,d,f,m);e=a=b=d=f=
m=null},e._opts.checkProgressInterval)}else c.removeItem(e._progKeys,a),e.log("Error requesting upload progress: "+s+" "+u);k=h=n=s=u=g=null}}catch(w){e.log("Error requesting upload progress: "+w.message)}},k.onreadystatechange=l,k.open("GET",g,!0),e._opts.nginxProgressUrl&&k.setRequestHeader(e._opts.nginxProgressHeader,a),k.setRequestHeader("X-Requested-With","XMLHttpRequest"),k.setRequestHeader("Accept","application/json, text/javascript, */*; q=0.01"),k.send())},_checkFile:function(a,b,c){var f=
this._opts.allowedExtensions,m=f.length,e=!1;if(0<m){for(b=b.toLowerCase();m--;)if(f[m].toLowerCase()==b){e=!0;break}if(!e)return this.removeCurrent(),this.log("File extension not permitted"),this._opts.onExtError.call(this,a,b),!1}return c&&!1!==this._opts.maxSize&&c>this._opts.maxSize?(this.removeCurrent(),this.log(a+" exceeds "+this._opts.maxSize+"K limit"),this._opts.onSizeError.call(this,a,c),!1):!0},submit:function(){var a,b,d;this._disabled||this._active>=this._opts.maxUploads||1>this._queue.length||
(this._file=this._queue[0],this._XhrOk?(a=c.getFilename(this._file.name),d=Math.round(this._file.size/1024)):a=c.getFilename(this._file.value),b=c.getExt(a),this._checkFile(a,b,d)&&!1!==this._opts.onSubmit.call(this,a,b)&&(this._active++,(!1===this._opts.multiple||!1===this._opts.queue&&this._active>=this._opts.maxUploads)&&this.disable(),this._XhrOk?this._uploadXhr(a,d,this._sizeBox,this._progBar,this._progBox,this._pctBox):this._uploadIframe(a,this._sizeBox,this._progBar,this._progBox,this._pctBox),
this._sizeBox=this._progBar=this._progBox=this._pctBox=null))}};p.ss=c})(window,document);